version: 2.1

#################################################################################

template_work_test_cd: &work_test_cd
  requires:
    - setup
  context: aws # test context : aws + server env var
  filters:
    branches:
      only:
        - /release.*/

template_cd_stag: &work_stag_cd
  requires:
    - setup
    - test_cd
  type: approval
  context: aws # stag context : aws + server env var
  filters:
    branches:
      only:
        - /release.*/

template_cd_prod: &work_prod_cd
  requires:
    - setup
  type: approval
  context: aws # prod context : aws + server env var
  filters:
    branches:
      only:
        - master


#################################################################################

orbs:
  aws-cli: circleci/aws-cli@0.1.16

jobs:
  setup:
    docker:
      - image: circleci/node:latest
    working_directory: ~/application
    steps:
      - checkout
      - run:
          name: Update NPM
          command: 'sudo npm install -g npm@latest'
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run:
          name: Install Package
          command: 'yarn install'
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - node_modules
      - save_cache:
          key: repo-$CIRCLE_BUILD_NUM-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/application
  test_cd:
    docker:
      - image: circleci/node:latest
    working_directory: ~/application
    executor: aws-cli/default
    steps:
      - aws-cli/setup:
          profile-name: default
      - restore_cache:
          key: repo-$CIRCLE_BUILD_NUM-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      # 설정 변경 로직 추가할 곳
      - run:
          name: Deploy TEST
          command: 'yarn build && yarn deploy'
      - run:
          name: Echo TEST
          command: echo 'TEST'
  stag_cd:
    docker:
      - image: circleci/node:latest
    working_directory: ~/application
    executor: aws-cli/default
    steps:
      # - aws-cli/setup:
      #     profile-name: default
      # - restore_cache:
      #     key: repo-$CIRCLE_BUILD_NUM-{{ .Environment.CIRCLE_SHA1 }}
      # - restore_cache:
      #     key: dependency-cache-{{ checksum "package.json" }}
      # 설정 변경 로직 추가할 곳
      # - run:
      #     name: Deploy STAG
      #     command: 'yarn build && yarn deploy'
      - run:
          name: Echo STAG
          command: echo 'STAG'
  prod_cd:
    docker:
      - image: circleci/node:latest
    working_directory: ~/application
    executor: aws-cli/default
    steps:
      # - aws-cli/setup:
      #     profile-name: default
      # - restore_cache:
      #     key: repo-$CIRCLE_BUILD_NUM-{{ .Environment.CIRCLE_SHA1 }}
      # - restore_cache:
      #     key: dependency-cache-{{ checksum "package.json" }}
      # 설정 변경 로직 추가할 곳
      # - run:
      #     name: Deploy PROD
      #     command: 'yarn build && yarn deploy'
      - run:
          name: Echo PROD
          command: echo 'PROD'

workflows:
  version: 2.1
  schedule_build:
    triggers:
      - schedule:
          cron: "0 19 * * *"
          filters:
            branches:
              only:
                - /release.*/
    jobs:
      - setup
      - test_cd:
          <<: *work_test_cd
      - stag_cd:
          <<: *work_stag_cd
  commit_build:
    jobs:
      - setup
      - test_cd:
          <<: *work_test_cd
      - stag_cd:
          <<: *work_stag_cd
  commit_prod:
    jobs:
      - setup
      - prod_cd:
          <<: *work_prod_cd